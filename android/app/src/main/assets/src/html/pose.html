<!DOCTYPE html>
<html>
  <head>
    <title>Posture Detection</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: gap:" />

    <!-- TensorFlow.js & Pose Detection -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
  </head>

  <body>
    <script>
      // Notify React Native that WebView has loaded

      window.addEventListener('load', () => {
        window.ReactNativeWebView.postMessage(
          JSON.stringify({
            type: 'log',
            message: '‚úÖ WebView script loaded!',
          }),
        );
      });

      let detector = null;

      async function initModel() {
        try {
          const model = poseDetection.SupportedModels.MoveNet;
          detector = await poseDetection.createDetector(model, {
            modelType: 'SinglePose.Lightning',
          });

          window.ReactNativeWebView.postMessage(
            JSON.stringify({
              type: 'ready',
              status: 'model_ready',
              message: '‚úÖ MoveNet loaded successfully',
              timestamp: Date.now(),
            }),
          );
        } catch (err) {
          window.ReactNativeWebView.postMessage(
            JSON.stringify({
              type: 'error',
              message: '‚ùå Failed to load MoveNet: ' + err.message,
            }),
          );
        }
      }

      function analyzePosture(pose) {
        const keypoints = pose[0]?.keypoints;
        if (!keypoints) return 'unknown';

        const leftShoulder = keypoints.find(p => p.name === 'left_shoulder');
        const leftEar = keypoints.find(p => p.name === 'left_ear');

        if (leftShoulder && leftEar) {
          const diff = Math.abs(leftShoulder.y - leftEar.y);
          return diff < 30 ? 'good' : 'bad';
        }

        return 'unknown';
      }

      async function predictPoseFromBase64(base64Image) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.src = base64Image;
          img.crossOrigin = 'anonymous';

          img.onload = async () => {
            try {
              if (!detector) {
                const errMsg = 'Detector not initialized';
                window.ReactNativeWebView.postMessage(
                  JSON.stringify({type: 'error', message: errMsg}),
                );
                return reject(errMsg);
              }

              img.style.display = 'none';
              document.body.appendChild(img);

              const pose = await detector.estimatePoses(img);

              window.ReactNativeWebView.postMessage(
                JSON.stringify({
                  type: 'log',
                  message: 'üì∏ Pose prediction completed',
                }),
              );

              const posture = analyzePosture(pose);

              window.ReactNativeWebView.postMessage(
                JSON.stringify({
                  type: 'posture_analysis',
                  status: 'posture_analysis',
                  posture,
                  pose,
                }),
              );

              document.body.removeChild(img);
              resolve(pose);
            } catch (err) {
              window.ReactNativeWebView.postMessage(
                JSON.stringify({
                  type: 'error',
                  message: '‚ùå Pose estimation error: ' + err.message,
                }),
              );
              reject(err);
            }
          };

          img.onerror = () => {
            const msg = 'Failed to load image';
            window.ReactNativeWebView.postMessage(
              JSON.stringify({
                type: 'error',
                message: '‚ùå ' + msg,
              }),
            );
            reject(new Error(msg));
          };
        });
      }

      function handleLogMessage(event) {
        try {
          const rawData = event.data;

          // Confirm receipt of raw data
          window.ReactNativeWebView.postMessage(
            JSON.stringify({
              type: 'log',
              message: 'üì© Received message from React Native',
              dataFrom: rawData.from,
            }),
          );

          // Parse the message if it's a JSON string
          const message =
          typeof rawData === 'string' ? JSON.parse(rawData) : rawData;

          

          if (message.command === 'predict' && message.image) {
            predictPoseFromBase64(message.image)
              .then(() => {
                window.ReactNativeWebView.postMessage(
                  JSON.stringify({
                    type: 'pose',
                    message: '‚úÖ Pose prediction completed',
                    pose: message.pose || "no pose data",
                    from:"handleLogMessage",
                    timestamp: Date.now(),
                  }),
                );
              })
              .catch(err => {
                window.ReactNativeWebView.postMessage(
                  JSON.stringify({
                    type: 'error',
                    message: '‚ùå Pose prediction failed: ' + err.message,
                    timestamp: Date.now(),
                  }),
                );
              });
          } else {
            window.ReactNativeWebView.postMessage(
              JSON.stringify({
                type: 'log',
                message: message.message || 'No message provided',
                from: message.from || 'unknown',
                timestamp: Date.now(),
              }),
            );
          }
        } catch (err) {
          window.ReactNativeWebView.postMessage(
            JSON.stringify({
              type: 'error',
              message: '‚ùå Error in handleLogMessage: ' + err.message,
              timestamp: Date.now(),
            }),
          );
        }
      }

      window.ReactNativeWebView.onMessage = handleLogMessage;
      document.addEventListener('message', handleLogMessage);
      window.ReactNativeWebView.postMessage(
        JSON.stringify({
          type: 'ping',
          message: 'üì° pose.html loaded and ready',
          timestamp: Date.now(),
        }),
      );
      initModel();
    </script>
  </body>
</html>
